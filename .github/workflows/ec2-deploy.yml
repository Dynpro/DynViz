name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Extract the commit SHA from the triggered workflow
      - name: Get commit SHA from build workflow
        id: sha
        run: echo "sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "====== Starting EC2 Deployment ======"

            SHA=${{ steps.sha.outputs.sha }}
            echo "Using SHA: $SHA"

            cd ~/DynViz

            echo "Stopping running containers..."
            sudo docker compose down || true

            echo "Logging in to Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            echo "Pulling SHA-tagged images..."
            sudo docker pull dynprobangalore/dynviz-v1:backend-$SHA
            sudo docker pull dynprobangalore/dynviz-v1:frontend-$SHA

            echo "Rewriting docker-compose.yml with latest SHA..."
            sudo sed -i "s|dynprobangalore/dynviz-v1:backend.*|dynprobangalore/dynviz-v1:backend-$SHA|g" docker-compose.yml
            sudo sed -i "s|dynprobangalore/dynviz-v1:frontend.*|dynprobangalore/dynviz-v1:frontend-$SHA|g" docker-compose.yml

            echo "Starting updated containers..."
            sudo docker compose up -d --remove-orphans

            echo "====== Deployment Complete Successfully ======"

            sudo docker-compose up -d --remove-orphans

            echo "Deployment complete!"
